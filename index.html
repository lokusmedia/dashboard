<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lokus Media - True Grmnt Live Campaign Dashboard (v11)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg0:#06080c; --bg1:#0a1322;
      --cyan:#06b6d4; --blue:#3b82f6; --mint:#22d3ee; --muted:#9fb3c8; --text:#eafaff;
      --green:#10b981; --red:#ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0;
      color:var(--text);
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(34,211,238,0.22), transparent 60%),
        radial-gradient(800px 500px at 100% 0%, rgba(59,130,246,0.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      background-attachment: fixed;
    }
    .wrap { max-width: 1360px; margin: 0 auto; padding: 16px 16px 40px; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.10); border-radius: 16px; }
    .chip { background: rgba(255,255,255,0.08); color: var(--muted); border-radius: 9999px; padding:4px 10px; font-size:12px; }
    .btn { background: var(--cyan); color:#001015; border:none; padding:10px 14px; border-radius:10px; font-weight:700; }
    .btn-ghost { background: rgba(255,255,255,0.08); color: var(--text); border:1px solid rgba(255,255,255,0.12); padding:10px 14px; border-radius:10px; font-weight:600; }
    .input, select { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.14); border-radius: 10px; padding:10px 12px; color: var(--text); }
    .muted { color: var(--muted); }
    .select-brand { border-color: rgba(34,211,238,0.30); }
    .select-brand:hover { border-color: rgba(34,211,238,0.65); box-shadow: 0 0 0 4px rgba(34,211,238,0.1); }
    .select-brand:focus { outline: none; border-color: #22d3ee; box-shadow: 0 0 0 4px rgba(34,211,238,0.2); }
    .ok, .err { display:none; white-space:pre-wrap; padding:10px; border-radius:12px; }
    .ok { background: rgba(16,185,129,0.12); border:1px solid rgba(16,185,129,0.35); color:#94f2c7; }
    .err { background: rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.35); color:#fecaca; }
    .chart-box { height: 260px; }
    .chart-box canvas { width:100% !important; height:100% !important; }
    .spark { height: 50px; }
    .spark canvas { width:100% !important; height:100% !important; }
    .table-scroll { max-height: 360px; overflow:auto; }
    .grid-gap { gap: 14px; }
    .big-metric { font-size: 44px; font-weight: 800; letter-spacing: .02em; }
    .white-icon { width:18px; height:18px; fill:#fff; opacity:0.95; }
    .row-alt tr:nth-child(odd){ background: rgba(255,255,255,0.03); }
    .xl-table td, .xl-table th { font-size: 15px; padding: 10px; }
    .perf-good { color:#86efac; } .perf-bad { color:#fca5a5; }
    @media (max-width: 1024px){ .chart-box { height: 220px; } }
    @media (max-width: 640px){ .chart-box { height: 200px; } .wrap { padding: 12px; } }
    details.settings summary { list-style: none; }
    details.settings summary::-webkit-details-marker { display: none; }
    .summary-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .summary-row .title { font-weight: 700; }
    .summary-row .hint { color: var(--muted); font-size: 12px; }
  
/* === Minor fixes (v11 patch) === */
/* Force white calendar icons inside native date inputs */
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1) brightness(1.2);
  opacity: 0.9;
}
/* Helps Firefox render native pickers for dark UI */
input[type="date"] { color-scheme: dark; }

/* Align 'Campaign' text left in all tables; keep numbers right */
#tblPerf th:first-child, #tblPerf td:first-child,
#tbl30 th:first-child, #tbl30 td:first-child,
#reachTop td:first-child, #visitorsTop td:first-child, #cpcTop td:first-child {
  text-align: left;
}

/* Ensure KPI and metric card text aligns left consistently */
.glass .text-xs, .glass .text-3xl, .glass .font-bold, .glass .muted {
  text-align: left;
}

/* Tighten vertical alignment for Spend/Revenue/ROAS KPI rows */
#kSpend, #kRev, #kRoas, #kPurch {
  line-height: 1.1;
}

/* Ensure filter labels and controls align baseline nicely */
input.input, select.input, .input {
  vertical-align: middle;
}

/* === v11 mini-table + last30 polish === */
/* Mini tables inside the big metric cards */
.metric-mini table { border-collapse: separate; border-spacing: 0; width: 100%; }
.metric-mini thead th { 
  background: transparent; color: #cde8ff; font-weight: 700; 
  padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.10); 
  text-align: left;
}
.metric-mini tbody td { 
  padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.06); 
}
.metric-mini tbody tr:last-child td { border-bottom: none; }
.metric-mini tbody td:last-child, .metric-mini thead th:last-child { text-align: right; }
.metric-mini tbody td:first-child, .metric-mini thead th:first-child { text-align: left; }

/* Last 30 Days table styling */
#tbl30 { border-collapse: separate; border-spacing: 0; width: 100%; }
#tbl30 thead th {
  background: transparent; color:#cde8ff; font-weight:700;
  padding: 10px 12px; border-bottom:1px solid rgba(255,255,255,0.12);
  text-align: left;
}
#tbl30 thead th.text-right { text-align: right; }
#tbl30 tbody td {
  padding: 10px 12px; border-bottom:1px solid rgba(255,255,255,0.06);
}
#tbl30 tbody tr:nth-child(odd) td { background: rgba(255,255,255,0.02); }
#tbl30 tbody td.text-right { text-align: right; }
#tbl30 tbody td:first-child { text-align: left; }

/* === Brand dropdown + calendar icon fixes === */
/* Make native select menus feel on-brand */
.select-brand {
  border-color: rgba(34,211,238,0.55);
  accent-color: #22d3ee;
}
.select-brand:hover {
  border-color: rgba(34,211,238,0.85);
  box-shadow: 0 0 0 4px rgba(34,211,238,0.12);
}
.select-brand:focus {
  outline: none;
  border-color: #22d3ee;
  box-shadow: 0 0 0 4px rgba(34,211,238,0.25);
}
/* Dropdown list colors (supported in modern Chromium/WebKit) */
.select-brand option {
  background-color: #0a1322;
  color: #eafaff;
}
.select-brand option:hover,
.select-brand option:focus {
  background-color: #0fcde6; /* Lokus cyan hover */
  color: #001015;
}
.select-brand option:checked {
  background-color: #22d3ee; /* selected item */
  color: #001015;
}

/* Force white calendar icons and add cyan hover glow */
input[type="date"]::-webkit-calendar-picker-indicator{
  filter: invert(1) brightness(1.8) contrast(1.1) saturate(1.2);
  opacity: 0.95;
}
input[type="date"]:hover::-webkit-calendar-picker-indicator{
  filter: invert(1) brightness(2) drop-shadow(0 0 4px rgba(34,211,238,0.8));
}
/* Help Firefox render native pickers in dark UIs */
input[type="date"]{ color-scheme: dark; }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Header / Title -->
    <div class="glass p-4 mb-4 flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="text-xl font-extrabold tracking-tight">Lokus Media - True Grmnt Live Campaign Dashboard</div>
        <span id="updatedAt" class="chip">Not updated yet</span>
        <span id="rowCount" class="chip">0 rows</span>
      </div>
      <div id="ok" class="ok"></div>
      <div id="err" class="err"></div>
    </div>

    <!-- Filters directly below title -->
    <div class="glass p-4 mb-4">
      <div class="font-bold mb-3 flex items-center justify-between">
        <span>Filters</span>
        <div class="flex gap-2 flex-wrap">
          <button class="btn-ghost text-xs" data-preset="today">Today</button>
          <button class="btn-ghost text-xs" data-preset="7">Last 7 days</button>
          <button class="btn-ghost text-xs" data-preset="30">Last 30 days</button>
          <button class="btn-ghost text-xs" data-preset="mtd">MTD</button>
          <button class="btn-ghost text-xs" data-preset="lastmonth">Last month</button>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 grid-gap">
        <div>
          <div class="muted text-sm mb-1">Campaign</div>
          <select id="campaignFilter" class="input select-brand w-full">
            <option value="__ALL__">All campaigns</option>
          </select>
        </div>
        <div>
          <div class="muted text-sm mb-1 flex items-center gap-2">
            <svg class="white-icon" viewBox="0 0 24 24"><path d="M7 10h5v5H7z"></path><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 14H5V9h14v9z"></path></svg>
            From
          </div>
          <input id="fromDate" type="date" class="input w-full">
        </div>
        <div>
          <div class="muted text-sm mb-1 flex items-center gap-2">
            <svg class="white-icon" viewBox="0 0 24 24"><path d="M7 10h5v5H7z"></path><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 14H5V9h14v9z"></path></svg>
            To
          </div>
          <input id="toDate" type="date" class="input w-full">
        </div>
      </div>
      <div class="mt-3">
        <button id="applyFilters" class="btn-ghost">Apply</button>
      </div>
    </div>

    <!-- Big metric blocks -->
    <div class="grid grid-cols-1 md:grid-cols-3 grid-gap mb-4">
      <div class="glass p-4">
        <div class="text-sm muted mb-1">Reach</div>
        <div id="reachBig" class="big-metric">—</div>
        <div class="table-scroll metric-mini mt-3">
          <table class="text-sm"><thead><tr><th>Campaign</th><th class="text-right">Reach</th></tr></thead><tbody id="reachTop"></tbody></table>
        </div>
      </div>
      <div class="glass p-4">
        <div class="text-sm muted mb-1">Website Visitors (Clicks)</div>
        <div id="visitorsBig" class="big-metric">—</div>
        <div class="table-scroll metric-mini mt-3">
          <table class="text-sm"><thead><tr><th>Campaign</th><th class="text-right">Clicks</th></tr></thead><tbody id="visitorsTop"></tbody></table>
        </div>
      </div>
      <div class="glass p-4">
        <div class="text-sm muted mb-1">Average CPC</div>
        <div id="cpcBig" class="big-metric">—</div>
        <div class="table-scroll metric-mini mt-3">
          <table class="text-sm"><thead><tr><th>Campaign</th><th class="text-right">CPC</th></tr></thead><tbody id="cpcTop"></tbody></table>
        </div>
      </div>
    </div>

    <!-- KPI row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 grid-gap mb-4">
      <div class="glass p-4">
        <div class="text-xs muted uppercase tracking-wider">Spend</div>
        <div class="text-3xl font-extrabold" id="kSpend">—</div>
        <div class="text-sm"><span id="kSpendDelta"></span> <span class="muted">vs prev period</span></div>
        <div class="spark"><canvas id="sparkSpend"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="text-xs muted uppercase tracking-wider">Revenue</div>
        <div class="text-3xl font-extrabold" id="kRev">—</div>
        <div class="text-sm"><span id="kRevDelta"></span> <span class="muted">vs prev period</span></div>
        <div class="spark"><canvas id="sparkRev"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="text-xs muted uppercase tracking-wider">ROAS</div>
        <div class="text-3xl font-extrabold" id="kRoas">—</div>
        <div class="text-sm"><span id="kRoasDelta"></span> <span class="muted">vs prev period</span></div>
        <div class="spark"><canvas id="sparkRoas"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="text-xs muted uppercase tracking-wider">Purchases</div>
        <div class="text-3xl font-extrabold" id="kPurch">—</div>
        <div class="text-sm"><span id="kPurchDelta"></span> <span class="muted">vs prev period</span></div>
        <div class="spark"><canvas id="sparkPurch"></canvas></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 grid-gap mb-4">
      <div class="glass p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold">Daily Spend</div><span class="chip" id="spendPts">0 pts</span>
        </div>
        <div class="chart-box"><canvas id="chartSpend"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold">Daily ROAS</div><span class="chip" id="roasPts">0 pts</span>
        </div>
        <div class="chart-box"><canvas id="chartRoas"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold">Spend Share by Campaign</div>
          <span class="chip" id="pieInfo">—</span>
        </div>
        <div class="chart-box"><canvas id="chartPie"></canvas></div>
      </div>
    </div>

    <!-- Top Performance Campaigns (ranked by ROAS) -->
    <div class="glass p-4 mb-4">
      <div class="font-bold mb-2">Top Performance Campaigns (ranked by ROAS)</div>
      <div class="table-scroll">
        <table id="tblPerf" class="text-sm row-alt xl-table">
          <thead>
            <tr>
              <th>Campaign</th>
              <th class="text-right">Spend</th>
              <th class="text-right">Revenue</th>
              <th class="text-right">ROAS</th>
              <th class="text-right">Purchases</th>
              <th class="text-right">Clicks</th>
              <th class="text-right">Impr.</th>
              <th class="text-right">Reach</th>
              <th class="text-right">CPC</th>
              <th class="text-right">CTR</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted text-xs mt-2">* Campaigns need at least $50 spend in the selected period to appear here.</div>
    </div>

    <!-- Last 30 Days (Daily) -->
    <div class="glass p-4 mb-12">
      <div class="font-bold mb-2">Last 30 Days (Daily)</div>
      <div class="table-scroll">
        <table id="tbl30" class="row-alt xl-table">
          <thead>
            <tr>
              <th>Date</th>
              <th class="text-right">Spend</th>
              <th class="text-right">Revenue</th>
              <th class="text-right">ROAS</th>
              <th class="text-right">Clicks</th>
              <th class="text-right">CPC</th>
              <th class="text-right">Reach</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Collapsible Settings at bottom -->
    <details class="settings glass p-4">
      <summary class="summary-row">
        <span class="title">Settings</span>
        <span class="hint">Data source & live refresh</span>
      </summary>
      <div class="mt-3 grid grid-cols-1 lg:grid-cols-3 grid-gap">
        <div class="flex flex-col gap-2">
          <label class="muted text-sm">Google Sheets CSV URL</label>
          <input id="csvUrl" class="input" placeholder="Publish-to-web CSV URL"/>
        </div>
        <div class="flex flex-col gap-2">
          <label class="muted text-sm">Auto-refresh (seconds)</label>
          <input id="refreshSecs" class="input" type="number" value="60" min="10" step="5" />
        </div>
        <div class="flex flex-col gap-2">
          <label class="muted text-sm">Options</label>
          <label class="flex items-center gap-2"><input id="useProxy" type="checkbox" checked/> <span>Use CORS proxy</span></label>
          <label class="flex items-center gap-2"><input id="cacheBust" type="checkbox" checked/> <span>Always cache-bust</span></label>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 mt-3">
        <button id="saveUrl" class="btn-ghost">Save</button>
        <button id="loadData" class="btn-ghost">Load</button>
        <button id="startAuto" class="btn-ghost">Auto</button>
        <button id="stopAuto" class="btn-ghost">Stop</button>
      </div>
    </details>
  </div>

<script>
// ===== helpers =====
const fmt2 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
const money = v => (v==null||isNaN(v)) ? "—" : "$" + fmt2.format(+v);
const pct   = v => (v==null||isNaN(v)) ? "—" : fmt2.format(+v*100) + "%";
const num   = v => (v==null||isNaN(v)) ? "—" : fmt2.format(+v);
function ymd(d){ return d.toISOString().slice(0,10); }

let RAW=[], FILT=[], timer=null;
let spendChart=null, roasChart=null, pieChart=null;
let sparkS=null, sparkR=null, sparkRo=null, sparkP=null;

function showOk(m){ const el=document.getElementById('ok'); el.textContent=m; el.style.display='block'; document.getElementById('err').style.display='none'; }
function showErr(m){ const el=document.getElementById('err'); el.textContent=m; el.style.display='block'; document.getElementById('ok').style.display='none'; }

function savePrefs(){
  localStorage.setItem('meta_csv_url', document.getElementById('csvUrl').value.trim());
  localStorage.setItem('meta_refresh_secs', document.getElementById('refreshSecs').value);
  showOk("Saved.");
}
function loadPrefs(){
  const u=localStorage.getItem('meta_csv_url'); if (u) document.getElementById('csvUrl').value=u;
  const s=localStorage.getItem('meta_refresh_secs'); if (s) document.getElementById('refreshSecs').value=s;
}

function addCacheBust(u){ const cb='cb='+Date.now(); return u+(u.includes('?')?'&':'?')+cb; }
function validateCsv(u){ const l=u.toLowerCase(); return l.includes('output=csv') || (l.includes('spreadsheets/d/') && l.includes('export') && l.includes('format=csv')); }

function parseDateFlexible(s){
  if (s == null) return null;
  if (!isNaN(s) && s!==""){ const n=Number(s); if (isFinite(n)){ const ms=(n-25569)*86400*1000; const d=new Date(ms); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); } }
  if (typeof s!=='string') s=String(s);
  const t=s.trim(); const iso=new Date(t); if (!isNaN(iso)) return new Date(iso.getFullYear(), iso.getMonth(), iso.getDate());
  if (t.includes('/')){ const [a,b,c]=t.split('/').map(x=>x.trim()); if (a&&b&&c){ const ddmm=new Date(+c, +b-1, +a); const mmdd=new Date(+c, +a-1, +b); if (+a>12 && !isNaN(ddmm)) return ddmm; if (+b>12 && !isNaN(mmdd)) return mmdd; if (!isNaN(ddmm)) return ddmm; if (!isNaN(mmdd)) return mmdd; } }
  if (t.includes('.')){ const [d,m,y]=t.split('.').map(x=>x.trim()); const dt=new Date(+y, +m-1, +d); if (!isNaN(dt)) return dt; }
  return null;
}
function parseNumFlexible(v){
  if (v==null||v==="") return 0;
  if (typeof v==='number' && isFinite(v)) return v;
  let s=String(v).trim();
  if (s.includes('.') && s.includes(',')){ s=s.replace(/\./g,'').replace(',', '.'); }
  else if (s.includes(',')){ const parts=s.split(','); if (parts.length===2 && parts[1].length<=2) s=parts[0]+'.'+parts[1]; else s=s.replace(/,/g,''); }
  s=s.replace(/[^0-9\.\-]/g,'');
  const n=Number(s); return isFinite(n)? n : 0;
}

// Fetch + parse
async function fetchCsv(){
  const base=document.getElementById('csvUrl').value.trim();
  if (!base){ showErr("Paste your Google Sheets publish-to-web CSV URL."); throw new Error("missing url"); }
  if (!validateCsv(base)){ showErr("This doesn't look like a proper CSV publish URL."); throw new Error("bad url"); }
  const url = document.getElementById('cacheBust').checked ? addCacheBust(base) : base;
  const final = document.getElementById('useProxy').checked ? ("https://corsproxy.io/?"+encodeURIComponent(url)) : url;
  const res = await fetch(final, { mode:'cors' });
  if (!res.ok) throw new Error("HTTP "+res.status);
  return await res.text();
}
function parseCsv(text){
  const res = Papa.parse(text, { header:true, dynamicTyping:true, skipEmptyLines:true });
  const rows = Array.isArray(res.data) ? res.data : [];
  return rows.map(r=>{
    const lower = Object.fromEntries(Object.entries(r).map(([k,v])=>[String(k).toLowerCase().trim(), v]));
    const d = parseDateFlexible(lower['date'] ?? lower['date_start'] ?? lower['day'] ?? lower['date_stop']);
    if (!d) return null;
    return {
      date:d,
      account_id: String(lower['account_id'] ?? ""),
      campaign_id: String(lower['campaign_id'] ?? ""),
      campaign_name: String(lower['campaign_name'] ?? ""),
      impressions: parseNumFlexible(lower['impressions']),
      reach: parseNumFlexible(lower['reach']),
      clicks: parseNumFlexible(lower['clicks']),
      spend: parseNumFlexible(lower['spend'] ?? lower['amount_spent'] ?? lower['amount spent'] ?? lower['amount spent (usd)']),
      purchases: parseNumFlexible(lower['purchases'] ?? lower['actions_purchase']),
      purchase_value: parseNumFlexible(lower['purchase_value'] ?? lower['revenue'] ?? lower['action_values_purchase'])
    };
  }).filter(Boolean).sort((a,b)=> a.date - b.date);
}

// Filtering & presets
function setPreset(preset){
  const now = new Date();
  let start=null, end=null;
  if (preset==='today'){ start=new Date(now.getFullYear(), now.getMonth(), now.getDate()); end=new Date(start); }
  else if (preset==='7'){ end=now; start=new Date(now); start.setDate(start.getDate()-6); }
  else if (preset==='30'){ end=now; start=new Date(now); start.setDate(start.getDate()-29); }
  else if (preset==='mtd'){ end=now; start=new Date(now.getFullYear(), now.getMonth(), 1); }
  else if (preset==='lastmonth'){
    const m = new Date(now.getFullYear(), now.getMonth()-1, 1);
    start = new Date(m.getFullYear(), m.getMonth(), 1);
    end   = new Date(m.getFullYear(), m.getMonth()+1, 0);
  }
  if (start && end){
    document.getElementById('fromDate').value = ymd(start);
    document.getElementById('toDate').value   = ymd(end);
    applyFilters();
  }
}
function applyFilters(){
  const from = document.getElementById('fromDate').value ? parseDateFlexible(document.getElementById('fromDate').value) : null;
  const to   = document.getElementById('toDate').value ? parseDateFlexible(document.getElementById('toDate').value) : null;
  const camp = document.getElementById('campaignFilter').value;
  FILT = RAW.filter(r => (!from || r.date>=from) && (!to || r.date<=to) && (camp==='__ALL__' || r.campaign_name===camp));
  fillCampaignFilter(RAW);
  updateAll();
}
function fillCampaignFilter(rows){
  const sel=document.getElementById('campaignFilter');
  if (sel.dataset.filled === '1') return;
  const seen=new Set();
  rows.forEach(r=>{ if (r.campaign_name && !seen.has(r.campaign_name)){ seen.add(r.campaign_name); const o=document.createElement('option'); o.value=r.campaign_name; o.textContent=r.campaign_name; sel.appendChild(o);} });
  sel.dataset.filled='1';
}

// Aggregations
function groupDaily(rows){
  const map=new Map();
  rows.forEach(r=>{
    const k=ymd(r.date);
    const cur=map.get(k)||{spend:0, rev:0, purch:0, clicks:0, impr:0, reach:0};
    cur.spend+=r.spend||0; cur.rev+=r.purchase_value||0; cur.purch+=r.purchases||0; cur.clicks+=r.clicks||0; cur.impr+=r.impressions||0; cur.reach+=r.reach||0;
    map.set(k,cur);
  });
  const labels=Array.from(map.keys()).sort();
  return {
    labels,
    spend:labels.map(d=>map.get(d).spend),
    rev:labels.map(d=>map.get(d).rev),
    roas:labels.map(d=>{const v=map.get(d); return v.spend? v.rev/v.spend:0;}),
    purch:labels.map(d=>map.get(d).purch),
    clicks:labels.map(d=>map.get(d).clicks),
    impr:labels.map(d=>map.get(d).impr),
    reach:labels.map(d=>map.get(d).reach),
    cpc:labels.map(d=>{const v=map.get(d); return v.clicks? v.spend/v.clicks:0;}),
  };
}

// Period deltas
function getPeriodDeltas(metric){
  if (!FILT.length) return {delta:0, sign:0, prevTotal:null, curTotal:0};
  const labels = Array.from(new Set(FILT.map(r=> ymd(r.date)))).sort();
  const days = labels.length;
  const start = new Date(labels[0]); const end = new Date(labels[labels.length-1]);
  const prevEnd = new Date(start); prevEnd.setDate(prevEnd.getDate()-1);
  const prevStart = new Date(prevEnd); prevStart.setDate(prevStart.getDate()-(days-1));

  const camp = document.getElementById('campaignFilter').value;
  const inCamp = (r)=> (camp==='__ALL__' || r.campaign_name===camp);

  const curTotal = RAW.filter(r => inCamp(r) && r.date>=start && r.date<=end).reduce((s,r)=> s + (r[metric]||0), 0);
  const prevTotal = RAW.filter(r => inCamp(r) && r.date>=prevStart && r.date<=prevEnd).reduce((s,r)=> s + (r[metric]||0), 0);

  if (!prevTotal) return {delta:0, sign:0, prevTotal, curTotal};
  const change = (curTotal - prevTotal) / prevTotal;
  return { delta: change, sign: change>=0 ? 1 : -1, prevTotal, curTotal };
}

// Big blocks
function updateBigBlocks(){
  const totalReach = FILT.reduce((s,r)=>s+(r.reach||0),0);
  const totalClicks = FILT.reduce((s,r)=>s+(r.clicks||0),0);
  const totalSpend = FILT.reduce((s,r)=>s+(r.spend||0),0);
  const cpc = totalClicks ? totalSpend/totalClicks : 0;
  document.getElementById('reachBig').textContent = num(totalReach);
  document.getElementById('visitorsBig').textContent = num(totalClicks);
  document.getElementById('cpcBig').textContent = cpc ? money(cpc) : "—";

  function topBy(metric, max=10){
    const map=new Map();
    FILT.forEach(r=>{ const k=r.campaign_name||'Unknown'; map.set(k, (map.get(k)||0) + (r[metric]||0)); });
    return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,max);
  }
  const reachTop = topBy('reach');
  const clicksTop = topBy('clicks');
  const cpcMap = new Map();
  FILT.forEach(r=>{
    const k=r.campaign_name||'Unknown';
    const cur=cpcMap.get(k)||{spend:0, clicks:0};
    cur.spend += r.spend||0; cur.clicks += r.clicks||0;
    cpcMap.set(k,cur);
  });
  const cpcTop = Array.from(cpcMap.entries()).map(([k,v])=>({name:k, cpc: v.clicks? v.spend/v.clicks : 0})).filter(x=>x.cpc>0).sort((a,b)=>a.cpc-b.cpc).slice(0,10);

  function fillTbody(id, arr, formatter){
    const tb=document.getElementById(id); tb.innerHTML='';
    arr.forEach(item=>{
      let name, val;
      if (Array.isArray(item)){ name=item[0]; val=item[1]; }
      else { name=item.name; val=item.cpc; }
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(name)}</td><td class="text-right">${formatter(val)}</td>`;
      tb.appendChild(tr);
    });
  }
  fillTbody('reachTop', reachTop, num);
  fillTbody('visitorsTop', clicksTop, num);
  fillTbody('cpcTop', cpcTop, v=> v ? ('$'+fmt2.format(v)) : '—');
}

// KPIs + Charts
function updateKPIs(){
  const g=groupDaily(FILT);
  const spendTotal=g.spend.reduce((a,b)=>a+b,0);
  const revTotal=g.rev.reduce((a,b)=>a+b,0);
  const purchTotal=g.purch.reduce((a,b)=>a+b,0);
  const roasAvg = spendTotal ? (revTotal/spendTotal) : 0;

  document.getElementById('kSpend').textContent = money(spendTotal);
  document.getElementById('kRev').textContent   = money(revTotal);
  document.getElementById('kPurch').textContent = num(purchTotal);
  document.getElementById('kRoas').textContent  = isFinite(roasAvg)? fmt2.format(roasAvg):"—";

  const dsp = getPeriodDeltas('spend');
  const dr  = getPeriodDeltas('purchase_value');
  const dp  = getPeriodDeltas('purchases');
  const roCur = dsp.curTotal ? dr.curTotal / dsp.curTotal : 0;
  const roPrev= dsp.prevTotal ? dr.prevTotal / dsp.prevTotal : null;
  let dro = {delta:0, sign:0};
  if (roPrev && roPrev!==0) { const ch = (roCur - roPrev) / roPrev; dro = { delta: ch, sign: ch>=0?1:-1 }; }

  const f = (x)=> (x.sign===0? '—' : (x.sign>0? '+' : '') + fmt2.format(x.delta*100) + '%');
  const cls = (x)=> (x.sign>=0? 'text-green-400' : 'text-red-400');
  document.getElementById('kSpendDelta').className = cls(dsp); document.getElementById('kSpendDelta').textContent=f(dsp);
  document.getElementById('kRevDelta').className   = cls(dr);  document.getElementById('kRevDelta').textContent=f(dr);
  document.getElementById('kPurchDelta').className = cls(dp);  document.getElementById('kPurchDelta').textContent=f(dp);
  document.getElementById('kRoasDelta').className  = cls(dro); document.getElementById('kRoasDelta').textContent=f(dro);

  // Sparklines
  const sparkCfg=(labels,data,color='#22d3ee')=>({ type:'line', data:{ labels, datasets:[{ data, borderColor:color, backgroundColor:'rgba(34,211,238,0.15)', tension:0.3, fill:true, borderWidth:2, pointRadius:0 }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, tooltip:{enabled:false}}, scales:{x:{display:false},y:{display:false}}}});
  const s1=document.getElementById('sparkSpend').getContext('2d');
  const s2=document.getElementById('sparkRev').getContext('2d');
  const s3=document.getElementById('sparkRoas').getContext('2d');
  const s4=document.getElementById('sparkPurch').getContext('2d');
  try{ if (sparkS) sparkS.destroy(); if (sparkR) sparkR.destroy(); if (sparkRo) sparkRo.destroy(); if (sparkP) sparkP.destroy(); }catch(e){}
  if (g.labels.length){
    sparkS=new Chart(s1, sparkCfg(g.labels,g.spend,'#22d3ee'));
    sparkR=new Chart(s2, sparkCfg(g.labels,g.rev,'#60a5fa'));
    sparkRo=new Chart(s3, sparkCfg(g.labels,g.roas,'#22d3ee'));
    sparkP=new Chart(s4, sparkCfg(g.labels,g.purch,'#60a5fa'));
  }
}

function updateCharts(){
  const g=groupDaily(FILT);
  document.getElementById('spendPts').textContent = g.labels.length+' pts';
  document.getElementById('roasPts').textContent  = g.labels.length+' pts';

  const spendCfg = { type:'bar', data:{ labels:g.labels, datasets:[{ label:'Spend', data:g.spend, backgroundColor:'rgba(34,211,238,0.35)', borderColor:'#22d3ee' }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#9fb3c8' }}, y:{ beginAtZero:true, ticks:{ color:'#9fb3c8' }, grid:{ color:'rgba(255,255,255,0.08)' }}}, plugins:{ legend:{ labels:{ color:'#d8ecff' }}} }};
  const roasCfg  = { type:'line', data:{ labels:g.labels, datasets:[{ label:'ROAS', data:g.roas, borderColor:'#22d3ee', backgroundColor:'rgba(34,211,238,0.15)', tension:0.3 }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#9fb3c8' }}, y:{ beginAtZero:true, ticks:{ color:'#9fb3c8' }, grid:{ color:'rgba(255,255,255,0.08)' }}}, plugins:{ legend:{ labels:{ color:'#d8ecff' }}} }};

  const ctxS=document.getElementById('chartSpend').getContext('2d');
  const ctxR=document.getElementById('chartRoas').getContext('2d');
  try{ if (spendChart) spendChart.destroy(); if (roasChart) roasChart.destroy(); }catch(e){}
  if (g.labels.length){
    spendChart=new Chart(ctxS, spendCfg);
    roasChart =new Chart(ctxR, roasCfg);
  }

  // Pie by campaign
  const byCamp=new Map();
  FILT.forEach(r=>{
    const k=r.campaign_name||'Unknown';
    byCamp.set(k, (byCamp.get(k)||0) + (r.spend||0));
  });
  const names=Array.from(byCamp.keys());
  const vals=Array.from(byCamp.values());
  document.getElementById('pieInfo').textContent = names.length ? names.length+' campaigns' : 'No data';
  const colors=['#22d3ee','#3b82f6','#67e8f9','#60a5fa','#06b6d4','#93c5fd','#0891b2','#1d4ed8','#0ea5e9','#38bdf8'];
  const ctxP=document.getElementById('chartPie').getContext('2d');
  try{ if (pieChart) pieChart.destroy(); }catch(e){}
  if (names.length){
    pieChart=new Chart(ctxP,{ type:'pie', data:{ labels:names, datasets:[{ data:vals, backgroundColor: colors.slice(0,names.length), borderColor:'rgba(0,0,0,0)'}] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#d8ecff' }}}}});
  }
}

// Tables
function updatePerfTable(){
  // Aggregate by campaign (filtered window)
  const agg=new Map();
  FILT.forEach(r=>{
    const k=r.campaign_name||'Unknown';
    const o=agg.get(k)||{spend:0, rev:0, purch:0, clicks:0, impr:0, reach:0};
    o.spend+=r.spend||0; o.rev+=r.purchase_value||0; o.purch+=r.purchases||0; o.clicks+=r.clicks||0; o.impr+=r.impressions||0; o.reach+=r.reach||0;
    agg.set(k,o);
  });
  const rows = Array.from(agg.entries())
    .map(([name,v])=>({ name, ...v, roas: v.spend? v.rev/v.spend:0, cpc: v.clicks? v.spend/v.clicks:0, ctr: v.impr? v.clicks/v.impr:0 }))
    .filter(r=> r.spend>=50) // threshold
    .sort((a,b)=> b.roas - a.roas)
    .slice(0,20);

  const tb=document.querySelector('#tblPerf tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const roasClass = r.roas>=2 ? 'perf-good' : (r.roas>0 && r.roas<1 ? 'perf-bad' : '');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.name)}</td>
      <td class="text-right">${money(r.spend)}</td>
      <td class="text-right">${money(r.rev)}</td>
      <td class="text-right ${roasClass}">${isFinite(r.roas)?fmt2.format(r.roas):'—'}</td>
      <td class="text-right">${num(r.purch)}</td>
      <td class="text-right">${num(r.clicks)}</td>
      <td class="text-right">${num(r.impr)}</td>
      <td class="text-right">${num(r.reach)}</td>
      <td class="text-right">${r.cpc? '$'+fmt2.format(r.cpc): '—'}</td>
      <td class="text-right">${r.ctr? fmt2.format(r.ctr*100)+'%':'—'}</td>
    `;
    tb.appendChild(tr);
  });
}

function updateLast30(){
  const now=new Date();
  const start=new Date(now); start.setDate(start.getDate()-29);
  // Aggregate on RAW to show global daily trend
  const map=new Map();
  RAW.forEach(r=>{
    if (r.date>=start && r.date<=now){
      const k=ymd(r.date);
      const cur=map.get(k)||{spend:0, rev:0, clicks:0, reach:0};
      cur.spend+=r.spend||0; cur.rev+=r.purchase_value||0; cur.clicks+=r.clicks||0; cur.reach+=r.reach||0;
      map.set(k,cur);
    }
  });
  const days=Array.from(map.keys()).sort();
  const tb=document.querySelector('#tbl30 tbody'); tb.innerHTML='';
  days.forEach(d=>{
    const v=map.get(d);
    const roas = v.spend? v.rev/v.spend:0;
    const cpc = v.clicks? v.spend/v.clicks:0;
    const roasClass = roas>=2 ? 'perf-good' : (roas>0 && roas<1 ? 'perf-bad' : '');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${d}</td>
      <td class="text-right">${money(v.spend)}</td>
      <td class="text-right">${money(v.rev)}</td>
      <td class="text-right ${roasClass}">${v.spend? fmt2.format(roas):'—'}</td>
      <td class="text-right">${num(v.clicks)}</td>
      <td class="text-right">${cpc? '$'+fmt2.format(cpc):'—'}</td>
      <td class="text-right">${num(v.reach)}</td>
    `;
    tb.appendChild(tr);
  });
}

function updateAll(){
  document.getElementById('rowCount').textContent = FILT.length+' rows';
  updateBigBlocks();
  updateKPIs();
  updateCharts();
  updatePerfTable();
  updateLast30();
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;"}[m])); }

// load + auto
async function loadData(){
  try{
    const txt = await fetchCsv();
    RAW = parseCsv(txt);
    const now=new Date(); document.getElementById('updatedAt').textContent='Updated '+now.toLocaleTimeString();
    if (!document.getElementById('fromDate').value){
      const from=new Date(now.getFullYear(), now.getMonth(), 1);
      document.getElementById('fromDate').value = ymd(from);
      document.getElementById('toDate').value   = ymd(now);
    }
    applyFilters();
    showOk("Loaded "+RAW.length+" rows.");
  }catch(e){
    showErr("Failed to load CSV. "+(e?.message||e));
  }
}
function startAuto(){
  stopAuto();
  const secs = Math.max(10, Number(document.getElementById('refreshSecs').value||60));
  loadData();
  timer = setInterval(loadData, secs*1000);
  showOk("Auto-refresh "+secs+"s.");
}
function stopAuto(){ if (timer){ clearInterval(timer); timer=null; showOk("Auto stopped."); } }

// events
document.getElementById('saveUrl').addEventListener('click', savePrefs);
document.getElementById('loadData').addEventListener('click', loadData);
document.getElementById('startAuto').addEventListener('click', startAuto);
document.getElementById('stopAuto').addEventListener('click', stopAuto);
document.getElementById('applyFilters').addEventListener('click', applyFilters);
document.querySelectorAll('[data-preset]').forEach(btn => {
  btn.addEventListener('click', (e)=> setPreset(e.currentTarget.getAttribute('data-preset')));
});

// init
(function init(){ loadPrefs(); })();
</script>
</body>
</html>
