
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lokus Media — Dashboard v13 (cards)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{ --bg0:#06080c; --bg1:#0a1322; --muted:#9fb3c8; --text:#eafaff; --cyan:#22d3ee; --green:#10b981; --red:#ef4444; }
    *{ box-sizing:border-box }
    body{ margin:0; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif; background:
      radial-gradient(900px 600px at 20% -10%, rgba(34,211,238,0.22), transparent 60%),
      radial-gradient(800px 500px at 100% 0%, rgba(59,130,246,0.18), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg0));
      background-attachment:fixed; }
    .wrap{ max-width:1360px; margin:0 auto; padding:16px 16px 40px }
    .glass{ background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.10); border-radius:16px }
    .chip{ background: rgba(255,255,255,0.08); color:var(--muted); border-radius:9999px; padding:4px 10px; font-size:12px }
    .btn-ghost{ background: rgba(255,255,255,0.08); color: var(--text); border:1px solid rgba(255,255,255,0.12); padding:10px 14px; border-radius:10px; font-weight:600 }
    .input, select{ background: rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.14); border-radius:10px; padding:10px 12px; color:var(--text) }
    .white-icon{ width:18px; height:18px; fill:#fff; opacity:.95 }
    .big-metric{ font-size:44px; font-weight:800; letter-spacing:.02em }
    .caption{ color:var(--muted); font-size:12px; margin-top:2px }
    .ok,.err{ display:none; white-space:pre-wrap; padding:10px; border-radius:12px }
    .ok{ background:rgba(16,185,129,0.12); border:1px solid rgba(16,185,129,0.35); color:#94f2c7 }
    .err{ background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.35); color:#fecaca }
    .chart-box{ height:260px } .chart-box canvas{ width:100%!important; height:100%!important }
    .spark{ height:50px } .spark canvas{ width:100%!important; height:100%!important }
    input[type="date"]{ color-scheme:dark }
    input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1) brightness(1.8) }
    /* enlarge From/To date inputs */
    #fromDate, #toDate { padding:14px 16px; font-size:16px; }

    /* Card-row style (like your screenshot) */
    .cards{ display:flex; flex-direction:column; gap:12px }
    .card-row{ display:grid; grid-template-columns: 72px 1fr auto; gap:14px; align-items:center; padding:12px 14px; border-radius:16px; border:1px solid rgba(255,255,255,0.10);
      background: radial-gradient(120% 120% at -10% -20%, rgba(255,255,255,0.08), rgba(255,255,255,0.03)); }
    .card-row:hover{ box-shadow:0 8px 24px rgba(2,244,255,0.08); border-color: rgba(34,211,238,0.35) }
    .thumb{ width:72px; height:72px; border-radius:12px; object-fit:cover; background:rgba(255,255,255,0.06) }
    .title{ font-weight:800; letter-spacing:.01em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .pills{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px }
    .pill{ font-size:12px; padding:4px 8px; border-radius:9999px; background:rgba(255,255,255,0.08); color:#cde8ff; border:1px solid rgba(255,255,255,0.10) }
    .pill strong{ color:#eafaff; margin-left:4px }
    .good{ border-color: rgba(16,185,129,0.45) } .bad{ border-color: rgba(239,68,68,0.45) }
    @media(max-width:640px){ .card-row{ grid-template-columns:56px 1fr; } .thumb{ width:56px; height:56px } }

    /* Small metric card list (for Reach/Clicks/CPC tops) */
    .mini-cards{ display:flex; flex-direction:column; gap:8px; margin-top:10px; max-height:320px; overflow:auto }
    .mini{ display:flex; justify-content:space-between; gap:10px; padding:8px 10px; border-radius:12px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08) }

    /* Custom styling for the filters panel (match the provided screenshot) */
    .filter-panel {
      /* Use a neutral dark gradient similar to the provided screenshot */
      background: linear-gradient(180deg, rgba(10,22,37,0.95), rgba(4,13,24,0.95));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 20px;
      padding: 20px;
    }
    .filter-panel .btn-ghost {
      background: rgba(10,22,37,0.9);
      border-color: rgba(255,255,255,0.18);
      color: #cde8ff;
      border-radius: 12px;
      padding: 10px 16px;
    }
    .filter-panel .btn-ghost:hover {
      border-color: rgba(255,255,255,0.3);
      background: rgba(10,22,37,0.8);
    }
    .filter-panel select.input,
    .filter-panel input[type="date"] {
      background: rgba(7,28,47,0.9);
      border: 1px solid rgba(34,211,238,0.45);
      border-radius: 12px;
      color: #eafaff;
      padding: 14px 16px;
      font-size: 15px;
    }
    .filter-panel select.input option {
      background-color: #0b2438;
      color: #eafaff;
    }
    .filter-panel select.input:focus,
    .filter-panel input[type="date"]:focus {
      outline: none;
      border-color: #22d3ee;
      box-shadow: 0 0 0 4px rgba(34,211,238,0.25);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="glass p-4 mb-4 flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="text-xl font-extrabold tracking-tight">Lokus Media — Live Campaign Dashboard</div>
        <span id="updatedAt" class="chip">Not updated yet</span>
        <span id="rowCount" class="chip">0 rows</span>
      </div>
      <div class="flex gap-2 items-center"><div id="ok" class="ok"></div><div id="err" class="err"></div></div>
    </div>

    <!-- Filters -->
    <div class="glass p-4 mb-4 filter-panel">
      <div class="font-bold mb-3 flex items-center justify-between">
        <span>Filters</span>
        <div class="flex gap-2 flex-wrap">
          <button class="btn-ghost text-xs" data-preset="today">Today</button>
          <button class="btn-ghost text-xs" data-preset="7">Last 7 days</button>
          <button class="btn-ghost text-xs" data-preset="30">Last 30 days</button>
          <button class="btn-ghost text-xs" data-preset="mtd">MTD</button>
          <button class="btn-ghost text-xs" data-preset="lastmonth">Last month</button>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <div class="text-sm text-[color:var(--muted)] mb-1">Campaign</div>
          <select id="campaignFilter" class="input">
            <option value="__ALL__">All campaigns</option>
          </select>
        </div>
        <div>
          <div class="text-sm text-[color:var(--muted)] mb-1 flex items-center gap-2">
            <svg class="white-icon" viewBox="0 0 24 24"><path d="M7 10h5v5H7z"></path><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 14H5V9h14v9z"></path></svg>
            From
          </div>
          <input id="fromDate" type="date" class="input">
        </div>
        <div>
          <div class="text-sm text-[color:var(--muted)] mb-1 flex items-center gap-2">
            <svg class="white-icon" viewBox="0 0 24 24"><path d="M7 10h5v5H7z"></path><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 14H5V9h14v9z"></path></svg>
            To
          </div>
          <input id="toDate" type="date" class="input">
        </div>
      </div>
      <div class="mt-3 flex gap-2 flex-wrap">
        <button id="applyFilters" class="btn-ghost">Apply</button>
      </div>
    </div>

    <!-- Big metric blocks (latest day only) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <div class="glass p-4">
        <div class="text-sm text-[color:var(--muted)]">Reach</div>
        <div id="reachBig" class="big-metric">—</div>
        <div id="reachCap" class="caption">—</div>
        <div class="mini-cards" id="reachMini"></div>
      </div>
      <div class="glass p-4">
        <div class="text-sm text-[color:var(--muted)]">Website Visitors (Clicks)</div>
        <div id="visitorsBig" class="big-metric">—</div>
        <div id="clicksCap" class="caption">—</div>
        <div class="mini-cards" id="clicksMini"></div>
      </div>
      <div class="glass p-4">
        <div class="text-sm text-[color:var(--muted)]">Average CPC</div>
        <div id="cpcBig" class="big-metric">—</div>
        <div id="cpcCap" class="caption">—</div>
        <div class="mini-cards" id="cpcMini"></div>
      </div>
    </div>

    <!-- KPI row (latest day totals + deltas) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
      <div class="glass p-4"><div class="text-xs text-[color:var(--muted)] uppercase">Spend</div><div class="text-3xl font-extrabold" id="kSpend">—</div><div class="text-sm"><span id="kSpendDelta"></span> <span class="text-[color:var(--muted)]">vs prev period</span></div><div class="spark"><canvas id="sparkSpend"></canvas></div></div>
      <div class="glass p-4"><div class="text-xs text-[color:var(--muted)] uppercase">Revenue</div><div class="text-3xl font-extrabold" id="kRev">—</div><div class="text-sm"><span id="kRevDelta"></span> <span class="text-[color:var(--muted)]">vs prev period</span></div><div class="spark"><canvas id="sparkRev"></canvas></div></div>
      <div class="glass p-4"><div class="text-xs text-[color:var(--muted)] uppercase">ROAS</div><div class="text-3xl font-extrabold" id="kRoas">—</div><div class="text-sm"><span id="kRoasDelta"></span> <span class="text-[color:var(--muted)]">vs prev period</span></div><div class="spark"><canvas id="sparkRoas"></canvas></div></div>
      <div class="glass p-4"><div class="text-xs text-[color:var(--muted)] uppercase">Purchases</div><div class="text-3xl font-extrabold" id="kPurch">—</div><div class="text-sm"><span id="kPurchDelta"></span> <span class="text-[color:var(--muted)]">vs prev period</span></div><div class="spark"><canvas id="sparkPurch"></canvas></div></div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-4">
      <div class="glass p-4">
        <div class="flex items-center justify-between mb-2"><div class="font-bold">Daily Spend</div><span class="chip" id="spendPts">0 pts</span></div>
        <div class="chart-box"><canvas id="chartSpend"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="flex items-center justify-between mb-2"><div class="font-bold">Daily ROAS</div><span class="chip" id="roasPts">0 pts</span></div>
        <div class="chart-box"><canvas id="chartRoas"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="flex items-center justify-between mb-2"><div class="font-bold">Spend Share by Campaign</div><span class="chip" id="pieInfo">—</span></div>
        <div class="chart-box"><canvas id="chartPie"></canvas></div>
      </div>
    </div>

    <!-- Campaign cards (period totals) -->
    <div class="glass p-4 mb-12">
      <div class="font-bold mb-2">Top Performance Campaigns (ranked by ROAS)</div>
      <div id="perfCards" class="cards"></div>
      <div class="text-xs text-[color:var(--muted)] mt-2">* All campaigns are shown regardless of spend.</div>
    </div>

    <!-- Settings (hidden) -->
    <details class="glass p-4" style="display:none;">
      <summary class="flex items-center justify-between cursor-pointer"><span class="font-bold">Settings</span><span class="chip">Data source & live refresh</span></summary>
      <div class="mt-3 grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="flex flex-col gap-2"><label class="text-sm text-[color:var(--muted)]">Google Sheets CSV URL</label><input id="csvUrl" class="input" placeholder="Publish-to-web CSV URL"/></div>
        <div class="flex flex-col gap-2"><label class="text-sm text-[color:var(--muted)]">Auto-refresh (seconds)</label><input id="refreshSecs" class="input" type="number" value="60" min="10" step="5" /></div>
        <div class="flex flex-col gap-2">
          <label class="text-sm text-[color:var(--muted)]">Options</label>
          <label class="flex items-center gap-2"><input id="useProxy" type="checkbox" checked/> <span>Use CORS proxy</span></label>
          <label class="flex items-center gap-2"><input id="cacheBust" type="checkbox" checked/> <span>Always cache-bust</span></label>
          <label class="flex items-center gap-2"><input id="autoStart" type="checkbox"/> <span>Auto-start on open</span></label>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 mt-3">
        <button id="saveUrl" class="btn-ghost">Save</button>
        <button id="loadData" class="btn-ghost">Load</button>
        <button id="startAuto" class="btn-ghost">Auto</button>
        <button id="stopAuto" class="btn-ghost">Stop</button>
      </div>
    </details>
  </div>

<script>
// ===== helpers =====
const fmt2 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
const money = v => (v==null||isNaN(v)) ? '—' : '$' + fmt2.format(+v);
const num   = v => (v==null||isNaN(v)) ? '—' : fmt2.format(+v);
function ymdLocal(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function showOk(m){ const el=document.getElementById('ok'); el.textContent=m; el.style.display='block'; document.getElementById('err').style.display='none'; }
function showErr(m){ const el=document.getElementById('err'); el.textContent=m; el.style.display='block'; document.getElementById('ok').style.display='none'; }

// ISO-friendly parser (Meta often gives YYYY-MM-DD or ISO with timezone); store as local-midnight date
function parseDateFlexible(s){
  if (s==null) return null;
  if (!isNaN(s) && s!==''){ const n=Number(s); if (isFinite(n)){ const ms=(n-25569)*86400*1000; const d=new Date(ms); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); } }
  if (typeof s!=='string') s=String(s);
  const t=s.trim();
  const m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(t);
  if (m){ return new Date(+m[1], +m[2]-1, +m[3]); }
  const d1=new Date(t); if (!isNaN(d1)) return new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
  if (t.includes('/')){ const [a,b,c]=t.split('/'); const ddmm=new Date(+c, +b-1, +a); const mmdd=new Date(+c, +a-1, +b); if (!isNaN(ddmm)) return ddmm; if (!isNaN(mmdd)) return mmdd; }
  if (t.includes('.')){ const [d,m2,y]=t.split('.'); const dt=new Date(+y, +m2-1, +d); if (!isNaN(dt)) return dt; }
  return null;
}
function parseNumFlexible(v){
  if (v==null||v==='') return 0;
  if (typeof v==='number' && isFinite(v)) return v;
  let s=String(v).trim();
  if (s.includes('.') && s.includes(',')){ s=s.replace(/\./g,'').replace(',', '.'); }
  else if (s.includes(',')){ const parts=s.split(','); if (parts.length===2 && parts[1].length<=2) s=parts[0]+'.'+parts[1]; else s=s.replace(/,/g,''); }
  s=s.replace(/[^0-9.\-]/g,'');
  const n=Number(s); return isFinite(n)? n:0;
}
function isSafeUrl(u){ try{ const url=new URL(u); return url.protocol==='https:'||url.protocol==='http:'; }catch{ return false; } }

// ===== state =====
let RAW=[], FILT=[], timer=null;
let spendChart=null, roasChart=null, pieChart=null, sparkS=null, sparkR=null, sparkRo=null, sparkP=null;

function savePrefs(){ localStorage.setItem('meta_csv_url', document.getElementById('csvUrl').value.trim()); localStorage.setItem('meta_refresh_secs', document.getElementById('refreshSecs').value); localStorage.setItem('meta_auto_start', document.getElementById('autoStart').checked?'1':'0'); showOk('Saved.'); }
function loadPrefs(){ const u=localStorage.getItem('meta_csv_url'); if(u) document.getElementById('csvUrl').value=u; const s=localStorage.getItem('meta_refresh_secs'); if(s) document.getElementById('refreshSecs').value=s; const a=localStorage.getItem('meta_auto_start'); if(a) document.getElementById('autoStart').checked = a==='1'; }
function addCacheBust(u){ const cb='cb='+Date.now(); return u+(u.includes('?')?'&':'?')+cb; }
function validateCsv(u){ const l=u.toLowerCase(); return l.includes('output=csv') || (l.includes('spreadsheets/d/') && l.includes('export') && l.includes('format=csv')); }

async function fetchCsv(){
  const base=document.getElementById('csvUrl').value.trim();
  if(!base){ showErr('Paste your Google Sheets publish-to-web CSV URL.'); throw new Error('missing url'); }
  if(!validateCsv(base)){ showErr("This doesn't look like a proper CSV publish URL."); throw new Error('bad url'); }
  const url=document.getElementById('cacheBust').checked? addCacheBust(base): base;
  const final=document.getElementById('useProxy').checked? ('https://corsproxy.io/?'+encodeURIComponent(url)): url;
  const res=await fetch(final,{mode:'cors'}); if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.text();
}
function parseCsv(text){
  const res=Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true});
  const rows=Array.isArray(res.data)? res.data: [];
  return rows.map(r=>{
    const lower=Object.fromEntries(Object.entries(r).map(([k,v])=>[String(k).toLowerCase().trim(), v]));
    const d=parseDateFlexible(lower['date']??lower['date_start']??lower['day']??lower['date_stop']); if(!d) return null;
    return {
      date:d,
      account_id:String(lower['account_id']??''),
      campaign_id:String(lower['campaign_id']??''),
      campaign_name:String(lower['campaign_name']??''),
      ad_id:String(lower['ad_id']??''),
      ad_name:String(lower['ad_name']??''),
      creative_url:String(lower['creative_url']??lower['image_url']??lower['thumbnail_url']??lower['ad_preview_url']??lower['permalink_url']??'').trim(),
      impressions:parseNumFlexible(lower['impressions']),
      reach:parseNumFlexible(lower['reach']),
      clicks:parseNumFlexible(lower['clicks']),
      spend:parseNumFlexible(lower['spend']??lower['amount_spent']??lower['amount spent']??lower['amount spent (usd)']),
      purchases:parseNumFlexible(lower['purchases']??lower['purchase']??lower['actions_purchase']),
      purchase_value:parseNumFlexible(lower['purchase_value']??lower['revenue']??lower['action_values_purchase'])
    };
  }).filter(Boolean).sort((a,b)=> a.date-b.date);
}

// ===== filtering =====
function setPreset(p){ const now=new Date(); let start=null,end=null; if(p==='today'){ start=new Date(now.getFullYear(),now.getMonth(),now.getDate()); end=new Date(start);} else if(p==='7'){ end=now; start=new Date(now); start.setDate(start.getDate()-6);} else if(p==='30'){ end=now; start=new Date(now); start.setDate(start.getDate()-29);} else if(p==='mtd'){ end=now; start=new Date(now.getFullYear(),now.getMonth(),1);} else if(p==='lastmonth'){ const m=new Date(now.getFullYear(),now.getMonth()-1,1); start=new Date(m.getFullYear(),m.getMonth(),1); end=new Date(m.getFullYear(),m.getMonth()+1,0);} if(start&&end){ document.getElementById('fromDate').value=ymdLocal(start); document.getElementById('toDate').value=ymdLocal(end); applyFilters(); } }
function applyFilters(){ const from=document.getElementById('fromDate').value? parseDateFlexible(document.getElementById('fromDate').value): null; const to=document.getElementById('toDate').value? parseDateFlexible(document.getElementById('toDate').value): null; const camp=document.getElementById('campaignFilter').value; FILT=RAW.filter(r=> (!from||r.date>=from)&&(!to||r.date<=to)&&(camp==='__ALL__'||r.campaign_name===camp)); fillCampaignFilter(RAW); updateAll(); }
function fillCampaignFilter(rows){ const sel=document.getElementById('campaignFilter'); if(sel.dataset.filled==='1') return; const seen=new Set(); rows.forEach(r=>{ const n=r.campaign_name||'Unknown'; if(!seen.has(n)){ seen.add(n); const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o);} }); sel.dataset.filled='1'; }

// ===== daily grouping (for charts & deltas) =====
function groupDaily(rows){ const map=new Map(); rows.forEach(r=>{ const k=ymdLocal(r.date); const cur=map.get(k)||{spend:0,rev:0,purch:0,clicks:0,impr:0,reach:0}; cur.spend+=r.spend||0; cur.rev+=r.purchase_value||0; cur.purch+=r.purchases||0; cur.clicks+=r.clicks||0; cur.impr+=r.impressions||0; cur.reach+=r.reach||0; map.set(k,cur); }); const labels=Array.from(map.keys()).sort(); return { labels, spend:labels.map(d=>map.get(d).spend), rev:labels.map(d=>map.get(d).rev), roas:labels.map(d=>{const v=map.get(d); return v.spend? v.rev/v.spend:0;}), purch:labels.map(d=>map.get(d).purch), clicks:labels.map(d=>map.get(d).clicks), impr:labels.map(d=>map.get(d).impr), reach:labels.map(d=>map.get(d).reach), cpc:labels.map(d=>{const v=map.get(d); return v.clicks? v.spend/v.clicks:0;}) };
}

function getPeriodDeltas(metric){ if(!FILT.length) return {delta:0,sign:0,prevTotal:null,curTotal:0}; const labels=Array.from(new Set(FILT.map(r=> ymdLocal(r.date)))).sort(); const days=labels.length; const start=new Date(labels[0]); const end=new Date(labels[labels.length-1]); const prevEnd=new Date(start); prevEnd.setDate(prevEnd.getDate()-1); const prevStart=new Date(prevEnd); prevStart.setDate(prevStart.getDate()-(days-1)); const camp=document.getElementById('campaignFilter').value; const inCamp=r=> (camp==='__ALL__'||r.campaign_name===camp); const curTotal=RAW.filter(r=> inCamp(r)&&r.date>=start&&r.date<=end).reduce((s,r)=> s+(r[metric]||0),0); const prevTotal=RAW.filter(r=> inCamp(r)&&r.date>=prevStart&&r.date<=prevEnd).reduce((s,r)=> s+(r[metric]||0),0); if(!prevTotal) return {delta:0,sign:0,prevTotal,curTotal}; const change=(curTotal-prevTotal)/prevTotal; return {delta:change,sign:change>=0?1:-1,prevTotal,curTotal}; }

// ===== Big blocks (LATEST DAY ONLY) =====
function latestDayRows(rows){ if(!rows.length) return {rows:[], key:null}; const last=rows.reduce((m,r)=> r.date>m? r.date:m, rows[0].date); const key=ymdLocal(last); return { rows: rows.filter(r=> ymdLocal(r.date)===key), key } }
function sumMetric(rows, f){ return rows.reduce((s,r)=> s+(r[f]||0),0); }
function renderMiniCards(id, items, fmt){ const wrap=document.getElementById(id); wrap.innerHTML=''; items.forEach(([name,val])=>{ const d=document.createElement('div'); d.className='mini'; d.innerHTML=`<div class="truncate">${name}</div><div>${fmt(val)}</div>`; wrap.appendChild(d); }); }
function updateBigBlocks(){ const {rows:dayRows, key}=latestDayRows(FILT); const totalReach=sumMetric(dayRows,'reach'); const totalClicks=sumMetric(dayRows,'clicks'); const totalSpend=sumMetric(dayRows,'spend'); const cpc= totalClicks? totalSpend/totalClicks: 0; document.getElementById('reachBig').textContent=num(totalReach); document.getElementById('visitorsBig').textContent=num(totalClicks); document.getElementById('cpcBig').textContent= cpc? money(cpc): '—'; document.getElementById('reachCap').textContent= key? ('as of '+key): '—'; document.getElementById('clicksCap').textContent= key? ('as of '+key): '—'; document.getElementById('cpcCap').textContent= key? ('as of '+key): '—'; const topBy=(metric,max=6)=>{ const m=new Map(); dayRows.forEach(r=>{ const k=r.campaign_name||'Unknown'; m.set(k,(m.get(k)||0)+(r[metric]||0)); }); return Array.from(m.entries()).sort((a,b)=> b[1]-a[1]).slice(0,max); }; renderMiniCards('reachMini', topBy('reach'), num); renderMiniCards('clicksMini', topBy('clicks'), num); // CPC top (lowest)
  const cpcAgg=new Map(); dayRows.forEach(r=>{ const k=r.campaign_name||'Unknown'; const o=cpcAgg.get(k)||{spend:0,clicks:0}; o.spend+=r.spend||0; o.clicks+=r.clicks||0; cpcAgg.set(k,o); }); const cpcTop=Array.from(cpcAgg.entries()).map(([k,v])=>[k, v.clicks? v.spend/v.clicks:0]).filter(([_,v])=>v>0).sort((a,b)=> a[1]-b[1]).slice(0,6); renderMiniCards('cpcMini', cpcTop, v=>'$'+fmt2.format(v)); }

// ===== KPIs + Charts (period totals) =====
function updateKPIs(){
  // We want the KPI values (Spend, Revenue, ROAS, Purchases) to reflect the latest date only,
  // summing across all campaigns. Use latestDayRows to compute these totals.
  const {rows:dayRows}=latestDayRows(FILT);
  const spendTotal = sumMetric(dayRows,'spend');
  const revTotal   = sumMetric(dayRows,'purchase_value');
  const purchTotal = sumMetric(dayRows,'purchases');
  const roasAvg    = spendTotal ? (revTotal/spendTotal) : 0;
  document.getElementById('kSpend').textContent = money(spendTotal);
  document.getElementById('kRev').textContent   = money(revTotal);
  document.getElementById('kPurch').textContent = num(purchTotal);
  document.getElementById('kRoas').textContent  = isFinite(roasAvg)? fmt2.format(roasAvg): '—';
  // The deltas still compare period totals (not latest-day totals) to previous period
  const dsp=getPeriodDeltas('spend');
  const dr=getPeriodDeltas('purchase_value');
  const dp=getPeriodDeltas('purchases');
  const roCur= dsp.curTotal? dr.curTotal/dsp.curTotal: 0;
  const roPrev= dsp.prevTotal? dr.prevTotal/dsp.prevTotal: null;
  let dro={delta:0,sign:0};
  if(roPrev && roPrev!==0){ const ch=(roCur-roPrev)/roPrev; dro={delta:ch,sign:ch>=0?1:-1}; }
  const f=x=> (x.sign===0? '—': (x.sign>0? '+':'')+fmt2.format(x.delta*100)+'%');
  const cls=x=> (x.sign>=0? 'text-green-400': 'text-red-400');
  document.getElementById('kSpendDelta').className=cls(dsp);
  document.getElementById('kSpendDelta').textContent=f(dsp);
  document.getElementById('kRevDelta').className=cls(dr);
  document.getElementById('kRevDelta').textContent=f(dr);
  document.getElementById('kPurchDelta').className=cls(dp);
  document.getElementById('kPurchDelta').textContent=f(dp);
  document.getElementById('kRoasDelta').className=cls(dro);
  document.getElementById('kRoasDelta').textContent=f(dro);
  // sparks remain unchanged (use period totals)
  const g=groupDaily(FILT);
  const sparkCfg=(labels,data,color='#22d3ee')=>({ type:'line', data:{ labels, datasets:[{ data, borderColor:color, backgroundColor:'rgba(34,211,238,0.15)', tension:0.3, fill:true, borderWidth:2, pointRadius:0 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, tooltip:{enabled:false}}, scales:{x:{display:false},y:{display:false}}}});
  try{ if(sparkS) sparkS.destroy(); if(sparkR) sparkR.destroy(); if(sparkRo) sparkRo.destroy(); if(sparkP) sparkP.destroy(); }catch{};
  if(g.labels.length){
    sparkS=new Chart(document.getElementById('sparkSpend').getContext('2d'), sparkCfg(g.labels,g.spend,'#22d3ee'));
    sparkR=new Chart(document.getElementById('sparkRev').getContext('2d'), sparkCfg(g.labels,g.rev,'#60a5fa'));
    sparkRo=new Chart(document.getElementById('sparkRoas').getContext('2d'), sparkCfg(g.labels,g.roas,'#22d3ee'));
    sparkP=new Chart(document.getElementById('sparkPurch').getContext('2d'), sparkCfg(g.labels,g.purch,'#60a5fa'));
  }
}

function updateCharts(){ const g=groupDaily(FILT); document.getElementById('spendPts').textContent=g.labels.length+' pts'; document.getElementById('roasPts').textContent=g.labels.length+' pts'; const spendCfg={ type:'bar', data:{ labels:g.labels, datasets:[{ label:'Spend', data:g.spend, backgroundColor:'rgba(34,211,238,0.35)', borderColor:'#22d3ee' }]}, options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#9fb3c8' }}, y:{ beginAtZero:true, ticks:{ color:'#9fb3c8' }, grid:{ color:'rgba(255,255,255,0.08)' }}}, plugins:{ legend:{ labels:{ color:'#d8ecff' }}} }}; const roasCfg={ type:'line', data:{ labels:g.labels, datasets:[{ label:'ROAS', data:g.roas, borderColor:'#22d3ee', backgroundColor:'rgba(34,211,238,0.15)', tension:0.3 }]}, options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#9fb3c8' }}, y:{ beginAtZero:true, ticks:{ color:'#9fb3c8' }, grid:{ color:'rgba(255,255,255,0.08)' }}}, plugins:{ legend:{ labels:{ color:'#d8ecff' }}} }}; try{ if(spendChart) spendChart.destroy(); if(roasChart) roasChart.destroy(); }catch{}; if(g.labels.length){ spendChart=new Chart(document.getElementById('chartSpend').getContext('2d'), spendCfg); roasChart=new Chart(document.getElementById('chartRoas').getContext('2d'), roasCfg); }
  const byCamp=new Map(); FILT.forEach(r=>{ const k=r.campaign_name||'Unknown'; byCamp.set(k,(byCamp.get(k)||0)+(r.spend||0)); }); const names=Array.from(byCamp.keys()); const vals=Array.from(byCamp.values()); document.getElementById('pieInfo').textContent= names.length? names.length+' campaigns': 'No data'; try{ if(pieChart) pieChart.destroy(); }catch{}; if(names.length){ const colors=['#22d3ee','#3b82f6','#67e8f9','#60a5fa','#06b6d4','#93c5fd','#0891b2','#1d4ed8','#0ea5e9','#38bdf8']; pieChart=new Chart(document.getElementById('chartPie').getContext('2d'), { type:'pie', data:{ labels:names, datasets:[{ data:vals, backgroundColor:colors.slice(0,names.length), borderColor:'rgba(0,0,0,0)'}] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#d8ecff' }}}}}); }
}

// ===== Campaign cards (period totals; with creative) =====
function pickCreativeForCampaign(rows){ const withCreative=rows.filter(r=> r.creative_url && isSafeUrl(r.creative_url)); if(!withCreative.length) return ''; withCreative.sort((a,b)=> b.date-a.date); return withCreative[0].creative_url; }
function campaignDailyUniqueReach(rows){ const byCamp=new Map(); rows.forEach(r=>{ const camp=r.campaign_name||'Unknown'; const d=ymdLocal(r.date); const inner=byCamp.get(camp)||new Map(); inner.set(d, Math.max(inner.get(d)||0, r.reach||0)); byCamp.set(camp, inner); }); const totals=new Map(); byCamp.forEach((m,c)=>{ const sum=Array.from(m.values()).reduce((a,b)=>a+b,0); totals.set(c,sum); }); return totals; }
function updatePerfCards(){ const agg=new Map(); const dailyRU=campaignDailyUniqueReach(FILT); FILT.forEach(r=>{ const k=r.campaign_name||'Unknown'; const o=agg.get(k)||{spend:0,rev:0,purch:0,clicks:0,impr:0,rows:[]}; o.spend+=r.spend||0; o.rev+=r.purchase_value||0; o.purch+=r.purchases||0; o.clicks+=r.clicks||0; o.impr+=r.impressions||0; o.rows.push(r); agg.set(k,o); }); const rows=Array.from(agg.entries()).map(([name,v])=>({ name, spend:v.spend, rev:v.rev, purch:v.purch, clicks:v.clicks, impr:v.impr, reach: dailyRU.get(name)||0, roas: v.spend? v.rev/v.spend:0, cpc: v.clicks? v.spend/v.clicks:0, ctr: v.impr? v.clicks/v.impr:0, creative: pickCreativeForCampaign(v.rows) })).filter(r=> r.spend>=50).sort((a,b)=> b.roas-a.roas).slice(0,20);
  const wrap=document.getElementById('perfCards'); wrap.innerHTML=''; rows.forEach(r=>{ const roasClass = r.roas>=2? 'good': (r.roas>0 && r.roas<1? 'bad' : ''); const thumb = r.creative? `<img src="${r.creative}" class="thumb" loading="lazy" referrerpolicy="no-referrer" onerror="this.style.display='none'"/>` : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#9fb3c8">—</div>`; const el=document.createElement('div'); el.className='card-row'; el.innerHTML=`
      ${thumb}
      <div>
        <div class="title" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
        <div class="pills">
          <span class="pill ${roasClass}">ROAS<strong>${isFinite(r.roas)? fmt2.format(r.roas):'—'}</strong></span>
          <span class="pill">Spend<strong>${money(r.spend)}</strong></span>
          <span class="pill">Rev<strong>${money(r.rev)}</strong></span>
          <span class="pill">Purch<strong>${num(r.purch)}</strong></span>
          <span class="pill">CTR<strong>${r.ctr? fmt2.format(r.ctr*100)+'%':'—'}</strong></span>
          <span class="pill">CPC<strong>${r.cpc? '$'+fmt2.format(r.cpc): '—'}</strong></span>
        </div>
      </div>
      <div></div>`; wrap.appendChild(el); }); }

// ===== flow =====
function updateAll(){ document.getElementById('rowCount').textContent=FILT.length+' rows'; updateBigBlocks(); updateKPIs(); updateCharts(); updatePerfCards(); }
function escapeHtml(s){ return String(s).replace(/[&<>"]+/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

async function loadData(){ try{ const txt=await fetchCsv(); RAW=parseCsv(txt); const now=new Date(); document.getElementById('updatedAt').textContent='Updated '+now.toLocaleTimeString(); if(!document.getElementById('fromDate').value){ const from=new Date(now.getFullYear(), now.getMonth(), 1); document.getElementById('fromDate').value=ymdLocal(from); document.getElementById('toDate').value=ymdLocal(now); } applyFilters(); showOk('Loaded '+RAW.length+' rows.'); }catch(e){ showErr('Failed to load CSV. '+(e?.message||e)); } }
function startAuto(){ stopAuto(); const secs=Math.max(10, Number(document.getElementById('refreshSecs').value||60)); loadData(); timer=setInterval(loadData, secs*1000); showOk('Auto-refresh '+secs+'s.'); }
function stopAuto(){ if(timer){ clearInterval(timer); timer=null; showOk('Auto stopped.'); } }

// Override updatePerfCards to remove the spend threshold and include all campaigns.
// This override recomputes aggregated metrics per campaign and populates
// the performance cards without filtering by spend. It retains the look and feel
// of the original cards while displaying up to 20 campaigns sorted by ROAS.
function updatePerfCards(){
  // Aggregate metrics per campaign
  const agg = new Map();
  const dailyRU = campaignDailyUniqueReach(FILT);
  FILT.forEach(r => {
    const key = r.campaign_name || 'Unknown';
    const o = agg.get(key) || { spend:0, rev:0, purch:0, clicks:0, impr:0, rows:[] };
    o.spend += r.spend || 0;
    o.rev   += r.purchase_value || 0;
    o.purch += r.purchases || 0;
    o.clicks+= r.clicks || 0;
    o.impr  += r.impressions || 0;
    o.rows.push(r);
    agg.set(key, o);
  });
  const rows = Array.from(agg.entries()).map(([name, v]) => {
    return {
      name,
      spend: v.spend,
      rev: v.rev,
      purch: v.purch,
      clicks: v.clicks,
      impr: v.impr,
      reach: dailyRU.get(name) || 0,
      roas: v.spend ? v.rev / v.spend : 0,
      cpc: v.clicks ? v.spend / v.clicks : 0,
      ctr: v.impr ? v.clicks / v.impr : 0,
      creative: pickCreativeForCampaign(v.rows)
    };
  }).sort((a,b) => b.roas - a.roas).slice(0, 20);
  const wrap = document.getElementById('perfCards');
  wrap.innerHTML = '';
  rows.forEach(r => {
    const roasClass = r.roas >= 2 ? 'good' : (r.roas > 0 && r.roas < 1 ? 'bad' : '');
    const thumb = r.creative
      ? `<img src="${r.creative}" class="thumb" loading="lazy" referrerpolicy="no-referrer" onerror="this.style.display='none'"/>`
      : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#9fb3c8">—</div>`;
    const el = document.createElement('div');
    el.className = 'card-row';
    el.innerHTML = `
      ${thumb}
      <div>
        <div class="title" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
        <div class="pills">
          <span class="pill ${roasClass}">ROAS<strong>${isFinite(r.roas) ? fmt2.format(r.roas) : '—'}</strong></span>
          <span class="pill">Spend<strong>${money(r.spend)}</strong></span>
          <span class="pill">Rev<strong>${money(r.rev)}</strong></span>
          <span class="pill">Purch<strong>${num(r.purch)}</strong></span>
          <span class="pill">CTR<strong>${r.ctr ? fmt2.format(r.ctr * 100) + '%' : '—'}</strong></span>
          <span class="pill">CPC<strong>${r.cpc ? '$' + fmt2.format(r.cpc) : '—'}</strong></span>
        </div>
      </div>
      <div></div>`;
    wrap.appendChild(el);
  });
}

// events
 document.getElementById('saveUrl')?.addEventListener('click', savePrefs);
 document.getElementById('loadData')?.addEventListener('click', loadData);
 document.getElementById('startAuto')?.addEventListener('click', startAuto);
 document.getElementById('stopAuto')?.addEventListener('click', stopAuto);
 document.getElementById('applyFilters').addEventListener('click', applyFilters);
 document.querySelectorAll('[data-preset]').forEach(btn=> btn.addEventListener('click', (e)=> setPreset(e.currentTarget.getAttribute('data-preset'))));

// init
(function init(){ loadPrefs(); const auto=localStorage.getItem('meta_auto_start')==='1'; const url=localStorage.getItem('meta_csv_url'); if(auto && url && url.trim().length){ startAuto(); } })();
</script>
<!-- ===== Lokus Portal Add-on (v12.3): Multi-client loader with safe namespacing ===== -->
<!-- ===== Lokus Portal Add-on (v12.4): Multi-client loader with URL auto-conversion ===== -->
<script>
/*
USAGE:
- Open with ?c=slug (or ?client=slug), e.g. .../dashboard.html?c=truegrmnt
- Registry columns (lower/upper case OK): slug, name, csv_url, refresh_secs, token
- You may put normal Google Sheets "edit" links in both the registry URL and each client's csv_url.
  This add-on will convert them to CSV export URLs automatically.
*/
(function PortalAddon(){
  // === YOUR REGISTRY (can be an "edit" link or a publish/export CSV link) ===
  const REGISTRY_EDIT_OR_CSV_URL = "https://docs.google.com/spreadsheets/d/1hpyeOXzDtuY92LYinTmVo3YZLCUny3X42flEWQtZH5Y/edit?gid=902655156#gid=902655156";
  const REQUIRE_TOKEN = false; // set true to require &t=<token> in the URL

  // ----- helpers (scoped) -----
  const qs = (sel)=> document.querySelector(sel);

  function waitFor(sel, tries=40, gap=250){
    return new Promise((resolve, reject)=>{
      (function poll(remaining){
        const el = qs(sel);
        if (el) return resolve(el);
        if (remaining <= 0) return reject(new Error("Element not found: "+sel));
        setTimeout(()=>poll(remaining-1), gap);
      })(tries);
    });
  }

  // Accepts edit/share/publish URLs and returns an export-to-CSV URL.
  function transformSheetUrl(u){
    if (!u) return "";
    const url = String(u).trim();
    const low = url.toLowerCase();
    // Already a CSV (publish-to-web style)?
    if (low.includes("output=csv") || (low.includes("/export") && low.includes("format=csv"))) {
      return url;
    }
    // Try to extract file id and gid for /d/<id>/edit?gid=<gid>
    const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
    const gidMatch = url.match(/[?&#]gid=([0-9]+)/);
    if (idMatch) {
      const id = idMatch[1];
      const gid = gidMatch ? gidMatch[1] : "0";
      return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`;
    }
    // If it's already the new “/d/e/...” publish URL, just force output=csv
    if (/\/spreadsheets\/d\/e\//i.test(url)) {
      const hasQuery = url.includes("?");
      const base = hasQuery ? url.replace(/([?&])output=[^&]*/i, "$1output=csv") : (url + (url.includes("?")?"":"?") + "output=csv");
      return base;
    }
    // Fallback: return as-is (the fetch will likely fail if it's not a public URL)
    return url;
  }

  function addCors(u){
    return "https://corsproxy.io/?" + encodeURIComponent(u);
  }

  function getSlug(){
    const u = new URL(location.href);
    const qp = u.searchParams.get("c") || u.searchParams.get("client");
    if (qp) return qp.trim().toLowerCase();
    const parts = u.pathname.split("/").filter(Boolean);
    const last = parts.length ? parts[parts.length-1] : "";
    if (last && !/\.[a-z0-9]+$/i.test(last)) return last.toLowerCase();
    return "";
  }

  async function fetchText(url){
    const final = addCors(url);
    const res = await fetch(final, { mode:"cors" });
    if (!res.ok) throw new Error("HTTP "+res.status);
    return await res.text();
  }

  function parseCsvWithPapa(text){
    if (typeof Papa !== "undefined"){
      const out = Papa.parse(text, { header:true, dynamicTyping:false, skipEmptyLines:true });
      return Array.isArray(out.data) ? out.data : [];
    }
    // ultra-simple fallback
    const lines = text.split(/\r?\n/).filter(Boolean);
    if (!lines.length) return [];
    const head = lines.shift().split(",").map(s=>s.trim());
    return lines.map(line=>{
      const cells = line.split(",");
      const o={};
      head.forEach((h,i)=> o[h.trim()] = (cells[i]||"").trim());
      return o;
    });
  }

  function normalizeKeys(row){
    const o = {};
    Object.keys(row).forEach(k=> o[String(k).toLowerCase().trim()] = row[k]);
    return o;
  }

  function banner(msg, ok=true){
    let el = document.getElementById("portal-debug");
    if (!el){
      el = document.createElement("div");
      el.id="portal-debug";
      el.style.cssText = "position:fixed;bottom:10px;left:10px;z-index:99999;font:12px/1.4 system-ui;"+
        "background:"+ (ok?"rgba(16,185,129,0.12)":"rgba(239,68,68,0.12)") +";border:1px solid "+(ok?"rgba(16,185,129,0.5)":"rgba(239,68,68,0.5)")+""+
        ";padding:8px 10px;border-radius:8px;color:#eafaff;max-width:60vw";
      document.body.appendChild(el);
    }
    el.textContent = msg;
    console.log("[Portal]", msg);
  }

  // ----- main -----
  (async function initPortal(){
    try{
      const slug = getSlug();
      if (!slug) return; // normal manual mode
      // 1) Load registry (convert edit/publish URL to CSV automatically)
      const registryCsvUrl = transformSheetUrl(REGISTRY_EDIT_OR_CSV_URL);
      banner("Loading registry…");
      const csvText = await fetchText(registryCsvUrl);
      const rows = parseCsvWithPapa(csvText).map(normalizeKeys);
      // 2) Find client by slug
      const row = rows.find(r => String(r.slug||"").trim().toLowerCase() === slug);
      if (!row) throw new Error("Client not found in registry: "+slug);
      // 3) Optional token check
      const token = String(row.token||"").trim();
      if (REQUIRE_TOKEN && token){
        const t = new URL(location.href).searchParams.get("t") || "";
        if (t !== token) throw new Error("Access token missing/invalid for "+slug);
      }
      // 4) Client CSV (convert whatever is in csv_url to export CSV)
      const rawClientUrl = String(row.csv_url||"").trim();
      if (!rawClientUrl) throw new Error("csv_url missing for "+slug);
      const clientCsv = transformSheetUrl(rawClientUrl);
      // 5) Refresh secs (optional)
      const secs = Number(row.refresh_secs||60);
      // 6) Write prefs + trigger load/auto
      localStorage.setItem("meta_csv_url", clientCsv);
      localStorage.setItem("meta_refresh_secs", String(isFinite(secs)&&secs>0?secs:60));
      banner(`Client '${slug}' → URL prepared. Waiting for UI…`);
      await waitFor("#csvUrl");
      const urlEl   = qs("#csvUrl");
      const loadBtn = qs("#loadData");
      const autoBtn = qs("#startAuto");
      if (!urlEl || !loadBtn) throw new Error("Dashboard controls not found (#csvUrl/#loadData).");
      urlEl.value = clientCsv;
      loadBtn.click();
      setTimeout(()=>{ if (autoBtn && secs>0) autoBtn.click(); }, 600);
      const det = qs("details.settings"); if (det) det.open = false;
      const titleEl = document.querySelector(".text-xl.font-extrabold");
      if (titleEl && row.name) titleEl.textContent = "Lokus Media — " + row.name + " Live Campaign Dashboard";
      banner("Auto-load triggered ✅");
    }catch(err){
      const ebox = document.getElementById("err");
      if (ebox){ ebox.textContent = "Portal error: " + (err.message||err); ebox.style.display="block"; }
      banner("Portal error: " + (err.message||err), false);
    }
  })();
})();
</script>
</body>
</html>
